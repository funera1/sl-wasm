From 911e2ba2b17bb4efb996d02e69c10047c5b7c66f Mon Sep 17 00:00:00 2001
From: Kosuke Nagano <gm.charlie@gmail.com>
Date: Tue, 8 Dec 2015 23:26:25 +0900
Subject: [PATCH] Apply patch of izumi@izumix.xyz

---
 header.h |  15 ++
 sl.c     | 741 ++++++++++++++++++++++++++++++++++++++++++++++++-------
 sl.h     | 142 ++++++++++-
 3 files changed, 811 insertions(+), 87 deletions(-)
 create mode 100644 header.h

diff --git a/header.h b/header.h
new file mode 100644
index 00000000..0dc42189
--- /dev/null
+++ b/header.h
@@ -0,0 +1,15 @@
+/*                   *
+ *                   *
+ *                   */
+
+extern int add_D51_coach();
+extern int add_D51_coach_r();
+extern int add_sl();
+extern int add_man();
+extern int add_smoke();
+extern int add_smoke_r();
+extern int add_cross();
+extern int begin_gate();
+extern int end_gate();
+extern int x_gate();
+extern void end_proc();
diff --git a/sl.c b/sl.c
index d8f2d750..8cb58408 100644
--- a/sl.c
+++ b/sl.c
@@ -3,9 +3,11 @@
  *        Copyright 1993,1998,2014
  *                  Toyoda Masashi
  *                  (mtoyoda@acm.org)
- *        Last Modified: 2014/06/03
+ *        Last Modified: 2015/12/08
  *========================================
  */
+/* sl version 5.02+: Apply patch of izumi@izumix.xyz                         */
+/*                                                                2015/12/08 */
 /* sl version 5.02 : Fix compiler warnings.                                  */
 /*                                              by Jeff Schwab    2014/06/03 */
 /* sl version 5.01 : removed cursor and handling of IO                       */
@@ -36,16 +38,27 @@
 /* sl version 1.00 : SL runs vomitting out smoke.                            */
 /*                                              by Toyoda Masashi 1992/12/11 */
 
+#include <stdio.h>
+#include <stdlib.h>
+#include <strings.h>
+#include <time.h>
 #include <curses.h>
 #include <signal.h>
 #include <unistd.h>
 #include "sl.h"
+#include "header.h"
+
+#define RTOL 0
+#define LTOR 1
+
+#ifndef useconds_t
+  #define USLEEP_ARG0_TYPE unsigned
+#else
+  #define USLEEP_ARG0_TYPE useconds_t
+#endif
 
-void add_smoke(int y, int x);
-void add_man(int y, int x);
 int add_C51(int x);
 int add_D51(int x);
-int add_sl(int x);
 void option(char *str);
 int my_mvaddstr(int y, int x, char *str);
 
@@ -53,14 +66,64 @@ int ACCIDENT  = 0;
 int LOGO      = 0;
 int FLY       = 0;
 int C51       = 0;
+int PASSNUM = 5;
+int ALL_LENGTH = 0;
+int DIREC = RTOL;
+int WAIT_TIME = 20000;
 
 int my_mvaddstr(int y, int x, char *str)
 {
-    for ( ; x < 0; ++x, ++str)
-        if (*str == '\0')  return ERR;
-    for ( ; *str != '\0'; ++str, ++x)
-        if (mvaddch(y, x, *str) == ERR)  return ERR;
-    return OK;
+  int i = 0;
+  
+  for ( ; x < 0; ++x, ++i) {
+    if (str[i] == '\0') {
+      return ERR;
+    }
+  }
+  if (mvaddnstr(y, x, &str[i], (int)COLS - x) == ERR) {
+    return ERR;
+  }
+  
+  return OK;
+}
+
+int my_mvaddstr_r(int y, int x, char *str)
+{
+  int i = 0;
+  char c;
+  
+  for ( ; x >= COLS; --x, ++i) {
+    if (str[i] == '\0') {
+      return ERR;
+    }
+  }
+  for ( ; str[i] != '\0'; ++i, --x) {
+    c = str[i];
+    switch (c) {
+    case '\\':
+      c = '/';
+      break;
+    case '/':
+      c = '\\';
+      break;
+    case '(':
+      c = ')';
+      break;
+    case ')':
+      c = '(';
+      break;
+    case '[':
+      c = ']';
+      break;
+    case ']':
+      c = '[';
+      break;
+    }
+    if (mvaddch(y, x, c) == ERR) {
+      return ERR;
+    }
+  }
+  return OK;
 }
 
 void option(char *str)
@@ -78,81 +141,6 @@ void option(char *str)
     }
 }
 
-int main(int argc, char *argv[])
-{
-    int x, i;
-
-    for (i = 1; i < argc; ++i) {
-        if (*argv[i] == '-') {
-            option(argv[i] + 1);
-        }
-    }